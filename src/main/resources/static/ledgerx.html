<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LedgerX — Financial Ledger</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,300;0,400;0,500;0,600;1,300&family=Neue+Haas+Grotesk+Display+Pro:wght@400;500;700&family=Fraunces:ital,opsz,wght@0,9..144,300;1,9..144,300&display=swap" rel="stylesheet" />
  <style>
    /* ═══════════════════════════════════════════
       DESIGN SYSTEM — Dark Terminal / Fintech
    ═══════════════════════════════════════════ */
    :root {
      --bg:         #080b0f;
      --bg-2:       #0d1117;
      --bg-3:       #141b24;
      --bg-4:       #1a2332;
      --border:     rgba(255,255,255,0.07);
      --border-lit: rgba(255,255,255,0.14);
      --amber:      #f5a623;
      --amber-dim:  #c4841b;
      --amber-glow: rgba(245,166,35,0.15);
      --green:      #22c55e;
      --green-dim:  #16a34a;
      --red:        #f43f5e;
      --red-dim:    #be123c;
      --blue:       #3b82f6;
      --text:       #e2e8f0;
      --text-2:     #94a3b8;
      --text-3:     #475569;
      --text-4:     #2d3748;
      --mono:       'IBM Plex Mono', monospace;
      --display:    'Fraunces', Georgia, serif;
      --r:          4px;
      --r-lg:       8px;
      --shadow:     0 4px 24px rgba(0,0,0,0.4);
      --shadow-lg:  0 8px 48px rgba(0,0,0,0.6);
      --tr:         all 0.18s ease;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html { font-size: 14px; }

    body {
      font-family: var(--mono);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      line-height: 1.5;
    }

    /* Noise texture overlay */
    body::before {
      content: '';
      position: fixed; inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 9999;
      opacity: 0.4;
    }

    ::-webkit-scrollbar { width: 3px; height: 3px; }
    ::-webkit-scrollbar-track { background: var(--bg-2); }
    ::-webkit-scrollbar-thumb { background: var(--border-lit); border-radius: 2px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--amber-dim); }

    /* ═══════════════════════════════════════════
       LAYOUT
    ═══════════════════════════════════════════ */
    .app { display: flex; height: 100vh; overflow: hidden; }

    /* ═══════════════════════════════════════════
       SIDEBAR
    ═══════════════════════════════════════════ */
    .sidebar {
      width: 240px;
      min-width: 240px;
      background: var(--bg-2);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    .sidebar-glow {
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 200px;
      background: radial-gradient(ellipse at 50% -30%, rgba(245,166,35,0.08) 0%, transparent 70%);
      pointer-events: none;
    }

    .logo-area {
      padding: 20px 20px 16px;
      border-bottom: 1px solid var(--border);
      position: relative;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
    }

    .logo-icon {
      width: 30px; height: 30px;
      background: var(--amber);
      border-radius: 3px;
      display: grid;
      place-items: center;
      font-size: 13px;
      color: var(--bg);
      font-weight: 600;
      position: relative;
      overflow: hidden;
    }

    .logo-icon::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.25) 0%, transparent 60%);
    }

    .logo-name {
      font-family: var(--mono);
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
      letter-spacing: -0.3px;
    }

    .logo-name span { color: var(--amber); }

    .logo-tag {
      font-size: 9px;
      color: var(--text-3);
      letter-spacing: 2.5px;
      text-transform: uppercase;
    }

    /* API config */
    .api-bar {
      padding: 10px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }

    .api-label {
      font-size: 9px;
      color: var(--text-3);
      letter-spacing: 2px;
      text-transform: uppercase;
      margin-bottom: 5px;
    }

    .api-input-row {
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .api-input {
      flex: 1;
      background: var(--bg-3);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 5px 8px;
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text-2);
      outline: none;
      transition: var(--tr);
    }

    .api-input:focus {
      border-color: var(--amber-dim);
      color: var(--text);
    }

    .status-pip {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--text-3);
      flex-shrink: 0;
      transition: var(--tr);
    }

    .status-pip.ok { background: var(--green); box-shadow: 0 0 6px var(--green); animation: pulse-green 2s infinite; }
    .status-pip.err { background: var(--red); box-shadow: 0 0 6px var(--red); }

    @keyframes pulse-green {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Nav */
    nav { flex: 1; padding: 12px 10px; overflow-y: auto; }

    .nav-section { margin-bottom: 20px; }

    .nav-section-title {
      font-size: 9px;
      color: var(--text-3);
      letter-spacing: 2.5px;
      text-transform: uppercase;
      padding: 0 10px 6px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: var(--r);
      cursor: pointer;
      transition: var(--tr);
      color: var(--text-3);
      font-size: 12px;
      user-select: none;
      position: relative;
    }

    .nav-item:hover {
      background: var(--bg-3);
      color: var(--text-2);
    }

    .nav-item.active {
      background: var(--amber-glow);
      color: var(--amber);
      border: 1px solid rgba(245,166,35,0.2);
    }

    .nav-item.active .nav-icon { color: var(--amber); }

    .nav-icon { font-size: 13px; width: 16px; text-align: center; flex-shrink: 0; }

    /* User pill at bottom */
    .sidebar-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
    }

    .user-pill {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      background: var(--bg-3);
      border-radius: var(--r);
      border: 1px solid var(--border);
    }

    .user-avatar {
      width: 26px; height: 26px;
      border-radius: 50%;
      background: var(--amber);
      display: grid;
      place-items: center;
      font-size: 10px;
      font-weight: 600;
      color: var(--bg);
      flex-shrink: 0;
    }

    .user-info { flex: 1; min-width: 0; }

    .user-email {
      font-size: 10px;
      color: var(--text-2);
      truncate: ellipsis;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    .user-id { font-size: 9px; color: var(--text-3); }

    .logout-btn {
      font-size: 11px;
      color: var(--text-3);
      cursor: pointer;
      transition: var(--tr);
      padding: 2px;
    }

    .logout-btn:hover { color: var(--red); }

    /* ═══════════════════════════════════════════
       MAIN
    ═══════════════════════════════════════════ */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--bg);
    }

    /* Topbar */
    .topbar {
      padding: 14px 28px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg-2);
      flex-shrink: 0;
    }

    .topbar-title {
      font-family: var(--display);
      font-size: 20px;
      font-weight: 300;
      color: var(--text);
      font-style: italic;
    }

    .topbar-title strong {
      font-style: normal;
      font-weight: 300;
      color: var(--amber);
    }

    .topbar-right { display: flex; align-items: center; gap: 12px; }

    .topbar-wallet {
      font-size: 11px;
      color: var(--text-3);
      padding: 5px 10px;
      background: var(--bg-3);
      border-radius: var(--r);
      border: 1px solid var(--border);
    }

    .topbar-wallet span { color: var(--text-2); }

    /* Content */
    .content { flex: 1; overflow-y: auto; padding: 24px 28px; }

    /* ═══════════════════════════════════════════
       AUTH SCREEN
    ═══════════════════════════════════════════ */
    .auth-screen {
      display: none;
      position: fixed; inset: 0;
      background: var(--bg);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }

    .auth-screen.visible { display: flex; }

    .auth-container {
      width: 380px;
      animation: fadeUp 0.4s ease;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(16px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .auth-logo {
      text-align: center;
      margin-bottom: 32px;
    }

    .auth-logo-mark {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .auth-logo-icon {
      width: 40px; height: 40px;
      background: var(--amber);
      border-radius: 6px;
      display: grid;
      place-items: center;
      font-size: 18px;
      color: var(--bg);
      font-weight: 700;
      font-family: var(--mono);
    }

    .auth-logo-text {
      font-family: var(--mono);
      font-size: 22px;
      font-weight: 600;
      color: var(--text);
    }

    .auth-logo-text span { color: var(--amber); }

    .auth-subtitle {
      font-family: var(--display);
      font-size: 13px;
      color: var(--text-3);
      font-style: italic;
    }

    /* Tabs */
    .auth-tabs {
      display: flex;
      background: var(--bg-2);
      border-radius: var(--r-lg);
      padding: 3px;
      margin-bottom: 24px;
      border: 1px solid var(--border);
    }

    .auth-tab {
      flex: 1;
      padding: 8px;
      text-align: center;
      font-size: 12px;
      color: var(--text-3);
      cursor: pointer;
      border-radius: 5px;
      transition: var(--tr);
    }

    .auth-tab.active {
      background: var(--bg-4);
      color: var(--amber);
      border: 1px solid rgba(245,166,35,0.2);
    }

    /* Form */
    .auth-card {
      background: var(--bg-2);
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      padding: 24px;
    }

    .form-group { margin-bottom: 14px; }

    .form-label {
      display: block;
      font-size: 10px;
      color: var(--text-3);
      letter-spacing: 1.5px;
      text-transform: uppercase;
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      background: var(--bg-3);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 10px 12px;
      font-family: var(--mono);
      font-size: 13px;
      color: var(--text);
      outline: none;
      transition: var(--tr);
    }

    .form-input:focus {
      border-color: var(--amber-dim);
      background: var(--bg-4);
    }

    .form-input::placeholder { color: var(--text-4); }

    .form-select {
      width: 100%;
      background: var(--bg-3);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 10px 12px;
      font-family: var(--mono);
      font-size: 13px;
      color: var(--text);
      outline: none;
      appearance: none;
      cursor: pointer;
    }

    .form-select:focus { border-color: var(--amber-dim); }
    .form-select option { background: var(--bg-3); }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 7px;
      padding: 10px 18px;
      border-radius: var(--r);
      border: none;
      font-family: var(--mono);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--tr);
      letter-spacing: 0.3px;
    }

    .btn-primary {
      background: var(--amber);
      color: var(--bg);
      width: 100%;
      padding: 12px;
    }

    .btn-primary:hover { background: var(--amber-dim); }
    .btn-primary:active { transform: scale(0.99); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .btn-ghost {
      background: transparent;
      color: var(--text-2);
      border: 1px solid var(--border);
    }

    .btn-ghost:hover { border-color: var(--border-lit); color: var(--text); background: var(--bg-3); }

    .btn-green { background: rgba(34,197,94,0.15); color: var(--green); border: 1px solid rgba(34,197,94,0.25); }
    .btn-green:hover { background: rgba(34,197,94,0.25); }

    .btn-red { background: rgba(244,63,94,0.15); color: var(--red); border: 1px solid rgba(244,63,94,0.25); }
    .btn-red:hover { background: rgba(244,63,94,0.25); }

    .btn-amber { background: var(--amber-glow); color: var(--amber); border: 1px solid rgba(245,166,35,0.25); }
    .btn-amber:hover { background: rgba(245,166,35,0.25); }

    .btn-sm { padding: 6px 12px; font-size: 11px; }

    /* ═══════════════════════════════════════════
       DASHBOARD
    ═══════════════════════════════════════════ */

    /* Stats row */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--bg-2);
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      padding: 16px 18px;
      transition: var(--tr);
      animation: fadeUp 0.4s ease backwards;
    }

    .stat-card:hover { border-color: var(--border-lit); }

    .stat-label {
      font-size: 9px;
      color: var(--text-3);
      letter-spacing: 2px;
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .stat-value {
      font-family: var(--display);
      font-size: 26px;
      font-weight: 300;
      color: var(--text);
      line-height: 1;
      margin-bottom: 4px;
    }

    .stat-value.green { color: var(--green); }
    .stat-value.amber { color: var(--amber); }

    .stat-sub { font-size: 10px; color: var(--text-3); }

    /* Section header */
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }

    .section-title {
      font-size: 11px;
      color: var(--text-2);
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    /* Transaction table */
    .tx-table-wrap {
      background: var(--bg-2);
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      overflow: hidden;
    }

    .tx-table { width: 100%; border-collapse: collapse; }

    .tx-table th {
      font-size: 9px;
      color: var(--text-3);
      letter-spacing: 2px;
      text-transform: uppercase;
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border);
      font-weight: 400;
      background: var(--bg-3);
    }

    .tx-table td {
      padding: 11px 16px;
      font-size: 12px;
      border-bottom: 1px solid var(--border);
      color: var(--text-2);
      vertical-align: middle;
    }

    .tx-table tr:last-child td { border-bottom: none; }

    .tx-table tr:hover td { background: rgba(255,255,255,0.02); }

    .tx-type-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 3px 8px;
      border-radius: 20px;
      font-size: 10px;
      font-weight: 500;
    }

    .badge-deposit { background: rgba(34,197,94,0.12); color: var(--green); border: 1px solid rgba(34,197,94,0.2); }
    .badge-withdrawal { background: rgba(244,63,94,0.12); color: var(--red); border: 1px solid rgba(244,63,94,0.2); }
    .badge-transfer_in { background: rgba(59,130,246,0.12); color: var(--blue); border: 1px solid rgba(59,130,246,0.2); }
    .badge-transfer_out { background: rgba(245,166,35,0.12); color: var(--amber); border: 1px solid rgba(245,166,35,0.2); }

    .tx-amount { font-family: var(--mono); font-weight: 500; }
    .tx-amount.credit { color: var(--green); }
    .tx-amount.debit { color: var(--red); }

    .tx-refid {
      font-size: 10px;
      color: var(--text-3);
      max-width: 140px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .empty-state {
      text-align: center;
      padding: 48px;
      color: var(--text-3);
      font-size: 12px;
    }

    .empty-icon { font-size: 28px; margin-bottom: 10px; }

    /* ═══════════════════════════════════════════
       TRANSACTION FORM PANEL
    ═══════════════════════════════════════════ */
    .panels-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }

    .panel {
      background: var(--bg-2);
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      padding: 18px;
      animation: fadeUp 0.4s ease backwards;
    }

    .panel-title {
      font-size: 10px;
      color: var(--text-3);
      letter-spacing: 2px;
      text-transform: uppercase;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-title-icon {
      width: 22px; height: 22px;
      border-radius: 4px;
      display: grid;
      place-items: center;
      font-size: 11px;
    }

    .icon-green { background: rgba(34,197,94,0.15); }
    .icon-red { background: rgba(244,63,94,0.15); }
    .icon-amber { background: rgba(245,166,35,0.15); }

    .input-group { margin-bottom: 10px; }

    .input-label {
      font-size: 9px;
      color: var(--text-3);
      letter-spacing: 1.5px;
      text-transform: uppercase;
      margin-bottom: 5px;
    }

    .input-field {
      width: 100%;
      background: var(--bg-3);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 8px 10px;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text);
      outline: none;
      transition: var(--tr);
    }

    .input-field:focus { border-color: var(--amber-dim); }
    .input-field::placeholder { color: var(--text-4); }

    .input-prefix-wrap {
      position: relative;
    }

    .input-prefix {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-3);
      font-size: 11px;
      pointer-events: none;
    }

    .input-field.has-prefix { padding-left: 24px; }

    .ref-gen-btn {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--bg-4);
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 2px 6px;
      font-family: var(--mono);
      font-size: 9px;
      color: var(--text-3);
      cursor: pointer;
      transition: var(--tr);
    }

    .ref-gen-btn:hover { color: var(--amber); border-color: var(--amber-dim); }

    /* ═══════════════════════════════════════════
       TOAST / ALERTS
    ═══════════════════════════════════════════ */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .toast {
      min-width: 280px;
      max-width: 360px;
      padding: 12px 16px;
      border-radius: var(--r-lg);
      font-size: 12px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      animation: slideIn 0.25s ease;
      box-shadow: var(--shadow);
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(20px); }
      to   { opacity: 1; transform: translateX(0); }
    }

    .toast.success { background: rgba(34,197,94,0.12); border: 1px solid rgba(34,197,94,0.3); color: var(--green); }
    .toast.error   { background: rgba(244,63,94,0.12); border: 1px solid rgba(244,63,94,0.3); color: var(--red); }
    .toast.info    { background: rgba(245,166,35,0.1); border: 1px solid rgba(245,166,35,0.25); color: var(--amber); }

    .toast-icon { font-size: 14px; flex-shrink: 0; margin-top: 0px; }
    .toast-body { flex: 1; }
    .toast-title { font-weight: 600; margin-bottom: 2px; }
    .toast-msg { opacity: 0.85; font-size: 11px; }
    .toast-close { cursor: pointer; opacity: 0.6; font-size: 13px; flex-shrink: 0; }
    .toast-close:hover { opacity: 1; }

    /* ═══════════════════════════════════════════
       LOADING
    ═══════════════════════════════════════════ */
    .loader {
      display: inline-block;
      width: 12px; height: 12px;
      border: 2px solid rgba(245,166,35,0.3);
      border-top-color: var(--amber);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ═══════════════════════════════════════════
       WALLET VIEW
    ═══════════════════════════════════════════ */
    .wallet-hero {
      background: var(--bg-2);
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      padding: 24px 28px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      animation: fadeUp 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .wallet-hero::before {
      content: '';
      position: absolute;
      right: -20px; top: -40px;
      width: 180px; height: 180px;
      background: radial-gradient(circle, rgba(245,166,35,0.07) 0%, transparent 70%);
      pointer-events: none;
    }

    .wallet-balance-label {
      font-size: 10px;
      color: var(--text-3);
      letter-spacing: 2px;
      text-transform: uppercase;
      margin-bottom: 6px;
    }

    .wallet-balance-amount {
      font-family: var(--display);
      font-size: 42px;
      font-weight: 300;
      color: var(--text);
      line-height: 1;
      margin-bottom: 6px;
    }

    .wallet-balance-currency {
      font-size: 11px;
      color: var(--amber);
      letter-spacing: 2px;
    }

    .wallet-meta {
      text-align: right;
    }

    .wallet-meta-item {
      font-size: 11px;
      color: var(--text-3);
      margin-bottom: 4px;
    }

    .wallet-meta-item span { color: var(--text-2); }

    /* Confirm overlay */
    .modal-overlay {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 200;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .modal-overlay.visible { display: flex; }

    .modal {
      background: var(--bg-2);
      border: 1px solid var(--border-lit);
      border-radius: var(--r-lg);
      padding: 24px;
      width: 380px;
      animation: fadeUp 0.2s ease;
    }

    .modal-title {
      font-size: 14px;
      color: var(--text);
      margin-bottom: 8px;
    }

    .modal-body { font-size: 12px; color: var(--text-2); margin-bottom: 20px; line-height: 1.6; }

    .modal-footer { display: flex; gap: 10px; justify-content: flex-end; }

    /* Lookup section */
    .lookup-row {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      margin-bottom: 20px;
    }

    .lookup-row .input-group { flex: 1; margin-bottom: 0; }

    /* Result card */
    .result-card {
      background: var(--bg-2);
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      padding: 18px;
      display: none;
      animation: fadeUp 0.25s ease;
    }

    .result-card.visible { display: block; }

    .result-row {
      display: flex;
      justify-content: space-between;
      padding: 7px 0;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
    }

    .result-row:last-child { border-bottom: none; }
    .result-key { color: var(--text-3); }
    .result-val { color: var(--text); font-family: var(--mono); }

    /* Page stagger animations */
    .stat-card:nth-child(1) { animation-delay: 0.05s; }
    .stat-card:nth-child(2) { animation-delay: 0.10s; }
    .stat-card:nth-child(3) { animation-delay: 0.15s; }
    .panel:nth-child(1) { animation-delay: 0.05s; }
    .panel:nth-child(2) { animation-delay: 0.10s; }
    .panel:nth-child(3) { animation-delay: 0.15s; }

    /* View switching */
    .view { display: none; }
    .view.active { display: block; }

    /* Misc */
    hr.divider { border: none; border-top: 1px solid var(--border); margin: 14px 0; }

    .text-green { color: var(--green); }
    .text-red   { color: var(--red); }
    .text-amber { color: var(--amber); }
    .text-dim   { color: var(--text-3); }
    .text-sm    { font-size: 11px; }

    .chip {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 20px;
      font-size: 9px;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .chip-green { background: rgba(34,197,94,0.12); color: var(--green); }
    .chip-amber { background: var(--amber-glow); color: var(--amber); }
    .chip-red   { background: rgba(244,63,94,0.12); color: var(--red); }

    .transfer-arrow {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: var(--amber);
      padding: 6px 0;
    }
  </style>
</head>
<body>

<!-- ═══════════════════════════════════════════════════════
     AUTH SCREEN
═══════════════════════════════════════════════════════ -->
<div class="auth-screen visible" id="authScreen">
  <div class="auth-container">
    <div class="auth-logo">
      <div class="auth-logo-mark">
        <div class="auth-logo-icon">Lx</div>
        <div class="auth-logo-text">Ledger<span>X</span></div>
      </div>
      <div class="auth-subtitle">Financial ledger system</div>
    </div>

    <div class="auth-tabs">
      <div class="auth-tab active" id="tabLogin" onclick="switchAuthTab('login')">Sign In</div>
      <div class="auth-tab" id="tabRegister" onclick="switchAuthTab('register')">Register</div>
    </div>

    <!-- Login Form -->
    <div class="auth-card" id="loginForm">
      <div class="form-group">
        <label class="form-label">Email</label>
        <input class="form-input" type="email" id="loginEmail" placeholder="user@example.com" />
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input class="form-input" type="password" id="loginPassword" placeholder="••••••••" />
      </div>
      <button class="btn btn-primary" id="loginBtn" onclick="doLogin()">
        <span id="loginBtnText">Sign In</span>
      </button>
    </div>

    <!-- Register Form -->
    <div class="auth-card" id="registerForm" style="display:none;">
      <div class="form-group">
        <label class="form-label">Email</label>
        <input class="form-input" type="email" id="regEmail" placeholder="user@example.com" />
      </div>
      <div class="form-group">
        <label class="form-label">Password <span class="text-dim text-sm">(min 8 chars)</span></label>
        <input class="form-input" type="password" id="regPassword" placeholder="••••••••" />
      </div>
      <div class="form-group">
        <label class="form-label">Currency</label>
        <select class="form-select" id="regCurrency">
          <option value="USD">USD — US Dollar</option>
          <option value="EUR">EUR — Euro</option>
          <option value="GBP">GBP — British Pound</option>
          <option value="INR">INR — Indian Rupee</option>
          <option value="JPY">JPY — Japanese Yen</option>
          <option value="BTC">BTC — Bitcoin</option>
          <option value="ETH">ETH — Ethereum</option>
        </select>
      </div>
      <button class="btn btn-primary" id="registerBtn" onclick="doRegister()">
        <span id="registerBtnText">Create Account</span>
      </button>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════
     MAIN APP
═══════════════════════════════════════════════════════ -->
<div class="app" id="mainApp" style="display:none;">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-glow"></div>

    <div class="logo-area">
      <div class="logo">
        <div class="logo-icon">Lx</div>
        <div>
          <div class="logo-name">Ledger<span>X</span></div>
          <div class="logo-tag">Financial Ledger</div>
        </div>
      </div>
    </div>

    <div class="api-bar">
      <div class="api-label">API Base URL</div>
      <div class="api-input-row">
        <input class="api-input" id="apiBaseUrl" value="http://localhost:8080/api" onchange="updateApiBase(this.value)" />
        <div class="status-pip" id="statusPip"></div>
      </div>
    </div>

    <nav>
      <div class="nav-section">
        <div class="nav-section-title">Overview</div>
        <div class="nav-item active" id="nav-dashboard" onclick="showView('dashboard')">
          <span class="nav-icon">◈</span> Dashboard
        </div>
        <div class="nav-item" id="nav-wallet" onclick="showView('wallet')">
          <span class="nav-icon">◉</span> Wallet
        </div>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Transactions</div>
        <div class="nav-item" id="nav-deposit" onclick="showView('deposit')">
          <span class="nav-icon">↓</span> Deposit
        </div>
        <div class="nav-item" id="nav-withdraw" onclick="showView('withdraw')">
          <span class="nav-icon">↑</span> Withdraw
        </div>
        <div class="nav-item" id="nav-transfer" onclick="showView('transfer')">
          <span class="nav-icon">⇄</span> Transfer
        </div>
        <div class="nav-item" id="nav-history" onclick="showView('history')">
          <span class="nav-icon">≡</span> History
        </div>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Lookup</div>
        <div class="nav-item" id="nav-lookup" onclick="showView('lookup')">
          <span class="nav-icon">⌕</span> Transaction Lookup
        </div>
      </div>
    </nav>

    <div class="sidebar-footer">
      <div class="user-pill">
        <div class="user-avatar" id="userAvatar">?</div>
        <div class="user-info">
          <div class="user-email" id="userEmailDisplay">—</div>
          <div class="user-id" id="userIdDisplay">ID: —</div>
        </div>
        <div class="logout-btn" onclick="doLogout()" title="Sign out">⏻</div>
      </div>
    </div>
  </aside>

  <!-- Main content -->
  <main class="main">
    <div class="topbar">
      <div class="topbar-title" id="topbarTitle">
        <strong>Dashboard</strong>
      </div>
      <div class="topbar-right">
        <div class="topbar-wallet" id="topbarWallet">
          Wallet <span id="topbarWalletId">—</span>
        </div>
        <button class="btn btn-ghost btn-sm" onclick="refreshCurrentView()">↺ Refresh</button>
      </div>
    </div>

    <div class="content">

      <!-- ── DASHBOARD ─────────────────────────────────── -->
      <div class="view active" id="view-dashboard">
        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-label">Current Balance</div>
            <div class="stat-value" id="dash-balance">—</div>
            <div class="stat-sub" id="dash-currency">Loading...</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Credited</div>
            <div class="stat-value green" id="dash-credited">—</div>
            <div class="stat-sub">All time inflows</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Debited</div>
            <div class="stat-value" style="color: var(--red)" id="dash-debited">—</div>
            <div class="stat-sub">All time outflows</div>
          </div>
        </div>

        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-label">Wallet ID</div>
            <div class="stat-value amber" id="dash-walletId">—</div>
            <div class="stat-sub">Your wallet identifier</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Transactions</div>
            <div class="stat-value" id="dash-txCount">—</div>
            <div class="stat-sub">Ledger entries</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Account Status</div>
            <div class="stat-value" id="dash-status">—</div>
            <div class="stat-sub">User account status</div>
          </div>
        </div>

        <div class="section-header">
          <div class="section-title">Recent Transactions</div>
          <button class="btn btn-ghost btn-sm" onclick="showView('history')">View All →</button>
        </div>

        <div class="tx-table-wrap">
          <table class="tx-table">
            <thead>
              <tr>
                <th>Type</th>
                <th>Amount</th>
                <th>Description</th>
                <th>Reference ID</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="dash-txTable">
              <tr><td colspan="5" class="empty-state"><div class="loader"></div></td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ── WALLET ──────────────────────────────────────── -->
      <div class="view" id="view-wallet">
        <div class="wallet-hero">
          <div>
            <div class="wallet-balance-label">Available Balance</div>
            <div class="wallet-balance-amount" id="wal-balance">—</div>
            <div class="wallet-balance-currency" id="wal-currency">—</div>
          </div>
          <div class="wallet-meta">
            <div class="wallet-meta-item">Wallet ID: <span id="wal-walletId">—</span></div>
            <div class="wallet-meta-item">User ID: <span id="wal-userId">—</span></div>
            <div class="wallet-meta-item">Updated: <span id="wal-updatedAt">—</span></div>
          </div>
        </div>

        <div class="panels-row" style="grid-template-columns: 1fr 1fr;">
          <div class="panel">
            <div class="panel-title">Quick Deposit</div>
            <div class="input-group">
              <div class="input-label">Amount</div>
              <div class="input-prefix-wrap">
                <span class="input-prefix">$</span>
                <input class="input-field has-prefix" type="number" id="qdep-amount" placeholder="0.00" step="0.01" min="0.01" />
              </div>
            </div>
            <div class="input-group">
              <div class="input-label">Description (optional)</div>
              <input class="input-field" type="text" id="qdep-desc" placeholder="Funds added" />
            </div>
            <button class="btn btn-green" style="width:100%" onclick="quickDeposit()">↓ Deposit Funds</button>
          </div>
          <div class="panel">
            <div class="panel-title">Quick Withdraw</div>
            <div class="input-group">
              <div class="input-label">Amount</div>
              <div class="input-prefix-wrap">
                <span class="input-prefix">$</span>
                <input class="input-field has-prefix" type="number" id="qwith-amount" placeholder="0.00" step="0.01" min="0.01" />
              </div>
            </div>
            <div class="input-group">
              <div class="input-label">Description (optional)</div>
              <input class="input-field" type="text" id="qwith-desc" placeholder="Funds withdrawn" />
            </div>
            <button class="btn btn-red" style="width:100%" onclick="quickWithdraw()">↑ Withdraw Funds</button>
          </div>
        </div>
      </div>

      <!-- ── DEPOSIT ─────────────────────────────────────── -->
      <div class="view" id="view-deposit">
        <div class="panel" style="max-width: 480px;">
          <div class="panel-title">
            <div class="panel-title-icon icon-green">↓</div>
            Deposit Funds
          </div>
          <div class="input-group">
            <div class="input-label">Amount</div>
            <div class="input-prefix-wrap">
              <span class="input-prefix">$</span>
              <input class="input-field has-prefix" type="number" id="dep-amount" placeholder="0.00" step="0.01" min="0.01" />
            </div>
          </div>
          <div class="input-group">
            <div class="input-label">Reference ID <span class="text-dim">(idempotency key)</span></div>
            <div style="position:relative">
              <input class="input-field" type="text" id="dep-ref" placeholder="e.g. dep-2024-001" style="padding-right: 64px" />
              <button class="ref-gen-btn" onclick="genRef('dep-ref')">gen</button>
            </div>
          </div>
          <div class="input-group">
            <div class="input-label">Description (optional)</div>
            <input class="input-field" type="text" id="dep-desc" placeholder="Bank transfer, paycheck, etc." />
          </div>
          <hr class="divider" />
          <button class="btn btn-green" style="width:100%" onclick="doDeposit()">
            <span id="depBtnText">↓ Deposit to Wallet</span>
          </button>
          <div class="result-card" id="dep-result"></div>
        </div>
      </div>

      <!-- ── WITHDRAW ────────────────────────────────────── -->
      <div class="view" id="view-withdraw">
        <div class="panel" style="max-width: 480px;">
          <div class="panel-title">
            <div class="panel-title-icon icon-red">↑</div>
            Withdraw Funds
          </div>
          <div class="input-group">
            <div class="input-label">Amount</div>
            <div class="input-prefix-wrap">
              <span class="input-prefix">$</span>
              <input class="input-field has-prefix" type="number" id="with-amount" placeholder="0.00" step="0.01" min="0.01" />
            </div>
          </div>
          <div class="input-group">
            <div class="input-label">Reference ID</div>
            <div style="position:relative">
              <input class="input-field" type="text" id="with-ref" placeholder="e.g. wth-2024-001" style="padding-right: 64px" />
              <button class="ref-gen-btn" onclick="genRef('with-ref')">gen</button>
            </div>
          </div>
          <div class="input-group">
            <div class="input-label">Description (optional)</div>
            <input class="input-field" type="text" id="with-desc" placeholder="Bill payment, transfer out, etc." />
          </div>
          <hr class="divider" />
          <div style="font-size:11px; color:var(--text-3); margin-bottom:12px;">
            Available: <span style="color:var(--text-2)" id="with-available">—</span>
          </div>
          <button class="btn btn-red" style="width:100%" onclick="doWithdraw()">
            <span id="withBtnText">↑ Withdraw from Wallet</span>
          </button>
          <div class="result-card" id="with-result"></div>
        </div>
      </div>

      <!-- ── TRANSFER ────────────────────────────────────── -->
      <div class="view" id="view-transfer">
        <div class="panel" style="max-width: 480px;">
          <div class="panel-title">
            <div class="panel-title-icon icon-amber">⇄</div>
            Transfer Funds
          </div>
          <div style="font-size:11px; color:var(--text-3); margin-bottom:14px; padding:10px; background:var(--bg-3); border-radius:var(--r); border:1px solid var(--border);">
            ↓ From: <span style="color:var(--amber)" id="trfFrom">Your wallet</span>
          </div>
          <div class="input-group">
            <div class="input-label">Destination Wallet ID</div>
            <input class="input-field" type="number" id="trf-toWallet" placeholder="e.g. 42" />
          </div>
          <div class="transfer-arrow">⇣</div>
          <div class="input-group">
            <div class="input-label">Amount</div>
            <div class="input-prefix-wrap">
              <span class="input-prefix">$</span>
              <input class="input-field has-prefix" type="number" id="trf-amount" placeholder="0.00" step="0.01" min="0.01" />
            </div>
          </div>
          <div class="input-group">
            <div class="input-label">Reference ID</div>
            <div style="position:relative">
              <input class="input-field" type="text" id="trf-ref" placeholder="e.g. trf-2024-001" style="padding-right: 64px" />
              <button class="ref-gen-btn" onclick="genRef('trf-ref')">gen</button>
            </div>
          </div>
          <div class="input-group">
            <div class="input-label">Description (optional)</div>
            <input class="input-field" type="text" id="trf-desc" placeholder="Payment to friend, etc." />
          </div>
          <hr class="divider" />
          <div style="font-size:11px; color:var(--text-3); margin-bottom:12px;">
            Available: <span style="color:var(--text-2)" id="trf-available">—</span>
          </div>
          <button class="btn btn-amber" style="width:100%" onclick="doTransfer()">
            <span id="trfBtnText">⇄ Execute Transfer</span>
          </button>
          <div class="result-card" id="trf-result"></div>
        </div>
      </div>

      <!-- ── HISTORY ─────────────────────────────────────── -->
      <div class="view" id="view-history">
        <div class="section-header">
          <div class="section-title">Transaction History</div>
          <button class="btn btn-ghost btn-sm" onclick="loadHistory()">↺ Refresh</button>
        </div>
        <div class="tx-table-wrap">
          <table class="tx-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Type</th>
                <th>Amount</th>
                <th>Description</th>
                <th>Reference ID</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="history-table">
              <tr><td colspan="6" class="empty-state"><div class="loader"></div></td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ── LOOKUP ──────────────────────────────────────── -->
      <div class="view" id="view-lookup">
        <div style="max-width: 560px;">
          <div class="lookup-row">
            <div class="input-group">
              <div class="input-label">Transaction Reference ID</div>
              <input class="input-field" type="text" id="lookup-ref" placeholder="Enter referenceId to look up..." />
            </div>
            <button class="btn btn-amber" onclick="doLookup()">⌕ Lookup</button>
          </div>

          <div class="result-card" id="lookup-result"></div>
        </div>
      </div>

    </div><!-- end .content -->
  </main>
</div>

<!-- Toast container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Confirm Modal -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal">
    <div class="modal-title" id="confirmTitle">Confirm Action</div>
    <div class="modal-body" id="confirmBody">Are you sure?</div>
    <div class="modal-footer">
      <button class="btn btn-ghost btn-sm" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary btn-sm" id="confirmOkBtn">Confirm</button>
    </div>
  </div>
</div>

<script>
/* ═══════════════════════════════════════════════════════
   STATE
═══════════════════════════════════════════════════════ */
let state = {
  apiBase: window.location.origin + '/api',
  token: null,
  userId: null,
  email: null,
  walletId: null,
  balance: null,
  currency: null,
  currentView: 'dashboard',
};

/* ═══════════════════════════════════════════════════════
   INIT
═══════════════════════════════════════════════════════ */
window.onload = () => {
  // Restore from sessionStorage
  const saved = sessionStorage.getItem('lx_session');
  if (saved) {
    try {
      const s = JSON.parse(saved);
      Object.assign(state, s);
      enterApp();
      loadDashboard();
    } catch(e) {
      sessionStorage.removeItem('lx_session');
    }
  }
};

function saveSession() {
  sessionStorage.setItem('lx_session', JSON.stringify({
    token: state.token,
    userId: state.userId,
    email: state.email,
    walletId: state.walletId,
    balance: state.balance,
    currency: state.currency,
    apiBase: state.apiBase,
  }));
}

function updateApiBase(v) {
  state.apiBase = v.trim().replace(/\/$/, '');
  saveSession();
}

/* ═══════════════════════════════════════════════════════
   API HELPER
═══════════════════════════════════════════════════════ */
async function api(method, path, body) {
  const headers = { 'Content-Type': 'application/json' };
  if (state.token) headers['Authorization'] = `Bearer ${state.token}`;

  const opts = { method, headers };
  if (body) opts.body = JSON.stringify(body);

  try {
    const res = await fetch(state.apiBase + path, opts);
    const data = await res.json().catch(() => ({}));

    if (!res.ok) {
      const msg = data.message || data.error || `HTTP ${res.status}`;
      throw new Error(msg);
    }
    setPip('ok');
    return data;
  } catch(e) {
    if (e.name === 'TypeError') {
      setPip('err');
      throw new Error('Cannot reach API server. Check the base URL and make sure the backend is running.');
    }
    setPip('err');
    throw e;
  }
}

function setPip(status) {
  const pip = document.getElementById('statusPip');
  pip.className = 'status-pip ' + status;
}

/* ═══════════════════════════════════════════════════════
   AUTH
═══════════════════════════════════════════════════════ */
function switchAuthTab(tab) {
  document.getElementById('tabLogin').classList.toggle('active', tab === 'login');
  document.getElementById('tabRegister').classList.toggle('active', tab === 'register');
  document.getElementById('loginForm').style.display = tab === 'login' ? '' : 'none';
  document.getElementById('registerForm').style.display = tab === 'register' ? '' : 'none';
}

async function doLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;

  if (!email || !password) { toast('error', 'Missing fields', 'Email and password required'); return; }

  const btn = document.getElementById('loginBtn');
  const txt = document.getElementById('loginBtnText');
  btn.disabled = true;
  txt.innerHTML = '<span class="loader"></span> Signing in...';

  try {
    const data = await api('POST', '/auth/login', { email, password });
    state.token = data.token;
    state.userId = data.userId;
    state.email = data.email;

    // Get wallet
    const user = await api('GET', `/users/${data.userId}`);
    state.walletId = user.walletId;
    state.balance = user.balance;
    state.currency = user.currency;

    saveSession();
    enterApp();
    toast('success', 'Welcome back', `Signed in as ${state.email}`);
    loadDashboard();
  } catch(e) {
    toast('error', 'Login failed', e.message);
  } finally {
    btn.disabled = false;
    txt.textContent = 'Sign In';
  }
}

async function doRegister() {
  const email = document.getElementById('regEmail').value.trim();
  const password = document.getElementById('regPassword').value;
  const currency = document.getElementById('regCurrency').value;

  if (!email || !password) { toast('error', 'Missing fields', 'All fields are required'); return; }

  const btn = document.getElementById('registerBtn');
  const txt = document.getElementById('registerBtnText');
  btn.disabled = true;
  txt.innerHTML = '<span class="loader"></span> Creating account...';

  try {
    const data = await api('POST', '/users/register', { email, password, currency });
    toast('success', 'Account created!', `Registered as ${data.email}. Please sign in.`);
    switchAuthTab('login');
    document.getElementById('loginEmail').value = email;
  } catch(e) {
    toast('error', 'Registration failed', e.message);
  } finally {
    btn.disabled = false;
    txt.textContent = 'Create Account';
  }
}

function doLogout() {
  state.token = null; state.userId = null; state.email = null;
  state.walletId = null; state.balance = null; state.currency = null;
  sessionStorage.removeItem('lx_session');

  document.getElementById('mainApp').style.display = 'none';
  document.getElementById('authScreen').classList.add('visible');
  setPip('');
}

function enterApp() {
  document.getElementById('authScreen').classList.remove('visible');
  document.getElementById('mainApp').style.display = 'flex';
  document.getElementById('apiBaseUrl').value = state.apiBase;

  // Update sidebar user info
  document.getElementById('userEmailDisplay').textContent = state.email || '—';
  document.getElementById('userIdDisplay').textContent = `ID: ${state.userId || '—'}`;
  const avatar = document.getElementById('userAvatar');
  avatar.textContent = (state.email || '?')[0].toUpperCase();

  // Update topbar
  document.getElementById('topbarWalletId').textContent = state.walletId || '—';

  // Update transfer from label
  document.getElementById('trfFrom').textContent = `Wallet #${state.walletId}`;
}

/* ═══════════════════════════════════════════════════════
   VIEW NAVIGATION
═══════════════════════════════════════════════════════ */
const viewTitles = {
  dashboard: 'Dashboard',
  wallet:    'Wallet Overview',
  deposit:   'Deposit',
  withdraw:  'Withdraw',
  transfer:  'Transfer',
  history:   'Transaction History',
  lookup:    'Transaction Lookup',
};

function showView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

  document.getElementById('view-' + name)?.classList.add('active');
  document.getElementById('nav-' + name)?.classList.add('active');

  const title = viewTitles[name] || name;
  document.getElementById('topbarTitle').innerHTML = `<strong>${title}</strong>`;

  state.currentView = name;

  // Lazy load data
  if (name === 'dashboard') loadDashboard();
  if (name === 'wallet') loadWallet();
  if (name === 'history') loadHistory();
  if (name === 'withdraw') loadWithdrawInfo();
  if (name === 'transfer') loadTransferInfo();
}

function refreshCurrentView() { showView(state.currentView); }

/* ═══════════════════════════════════════════════════════
   DASHBOARD
═══════════════════════════════════════════════════════ */
async function loadDashboard() {
  if (!state.walletId) return;

  try {
    const [wallet, txs, user] = await Promise.all([
      api('GET', `/wallets/${state.walletId}`),
      api('GET', `/wallets/${state.walletId}/transactions`),
      api('GET', `/users/${state.userId}`),
    ]);

    state.balance = wallet.balance;
    state.currency = wallet.currency;

    document.getElementById('dash-balance').textContent = formatMoney(wallet.balance, wallet.currency);
    document.getElementById('dash-currency').textContent = wallet.currency;
    document.getElementById('dash-walletId').textContent = `#${wallet.walletId}`;
    document.getElementById('dash-txCount').textContent = txs.length;
    document.getElementById('dash-status').innerHTML = `<span class="chip chip-green">${user.status}</span>`;

    // Compute totals
    let credited = 0, debited = 0;
    txs.forEach(tx => {
      const amt = parseFloat(tx.amount);
      if (amt > 0) credited += amt;
      else debited += Math.abs(amt);
    });

    document.getElementById('dash-credited').textContent = formatMoney(credited, wallet.currency);
    document.getElementById('dash-debited').textContent = formatMoney(debited, wallet.currency);

    // Recent 5
    const tbody = document.getElementById('dash-txTable');
    const recent = [...txs].reverse().slice(0, 5);
    renderTxRows(tbody, recent, false);

  } catch(e) {
    toast('error', 'Load failed', e.message);
  }
}

/* ═══════════════════════════════════════════════════════
   WALLET
═══════════════════════════════════════════════════════ */
async function loadWallet() {
  if (!state.walletId) return;
  try {
    const wallet = await api('GET', `/wallets/${state.walletId}`);
    state.balance = wallet.balance;
    state.currency = wallet.currency;

    document.getElementById('wal-balance').textContent = formatMoney(wallet.balance, wallet.currency);
    document.getElementById('wal-currency').textContent = wallet.currency;
    document.getElementById('wal-walletId').textContent = wallet.walletId;
    document.getElementById('wal-userId').textContent = wallet.userId;
    document.getElementById('wal-updatedAt').textContent = formatDate(wallet.updatedAt);
  } catch(e) {
    toast('error', 'Failed to load wallet', e.message);
  }
}

/* ═══════════════════════════════════════════════════════
   HISTORY
═══════════════════════════════════════════════════════ */
async function loadHistory() {
  if (!state.walletId) return;
  const tbody = document.getElementById('history-table');
  tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="loader"></div></td></tr>';

  try {
    const txs = await api('GET', `/wallets/${state.walletId}/transactions`);
    renderTxRows(tbody, [...txs].reverse(), true);
  } catch(e) {
    tbody.innerHTML = `<tr><td colspan="6" class="empty-state" style="color:var(--red)">${e.message}</td></tr>`;
  }
}

function renderTxRows(tbody, txs, showId) {
  if (!txs.length) {
    tbody.innerHTML = `<tr><td colspan="${showId ? 6 : 5}" class="empty-state">
      <div class="empty-icon">◈</div>No transactions yet</td></tr>`;
    return;
  }

  tbody.innerHTML = txs.map(tx => {
    const isCredit = parseFloat(tx.amount) > 0;
    const badge = badgeForType(tx.type);
    const amtClass = isCredit ? 'credit' : 'debit';
    const amtPrefix = isCredit ? '+' : '';
    const idCol = showId ? `<td style="color:var(--text-3); font-size:11px">#${tx.transactionId}</td>` : '';
    return `<tr>
      ${idCol}
      <td>${badge}</td>
      <td class="tx-amount ${amtClass}">${amtPrefix}${formatMoney(Math.abs(tx.amount), state.currency)}</td>
      <td style="color:var(--text-2); font-size:11px">${tx.description || '—'}</td>
      <td><div class="tx-refid" title="${tx.referenceId}">${tx.referenceId}</div></td>
      <td style="font-size:11px; color:var(--text-3)">${formatDate(tx.createdAt)}</td>
    </tr>`;
  }).join('');
}

function badgeForType(type) {
  const t = (type || '').toLowerCase();
  const labels = {
    deposit: '↓ Deposit',
    withdrawal: '↑ Withdrawal',
    transfer_in: '→ Transfer In',
    transfer_out: '← Transfer Out',
    fee: '% Fee',
    refund: '↩ Refund',
    adjustment: '± Adjust',
  };
  return `<span class="tx-type-badge badge-${t}">${labels[t] || type}</span>`;
}

/* ═══════════════════════════════════════════════════════
   DEPOSIT
═══════════════════════════════════════════════════════ */
async function quickDeposit() {
  const amount = document.getElementById('qdep-amount').value;
  const desc = document.getElementById('qdep-desc').value;
  if (!amount) { toast('error', 'Missing amount', 'Enter an amount to deposit'); return; }
  await executeDeposit(amount, genRefValue(), desc, 'qdep');
}

async function doDeposit() {
  const amount = document.getElementById('dep-amount').value;
  const ref = document.getElementById('dep-ref').value.trim();
  const desc = document.getElementById('dep-desc').value;

  if (!amount || !ref) { toast('error', 'Missing fields', 'Amount and Reference ID are required'); return; }
  await executeDeposit(amount, ref, desc, 'dep');
}

async function executeDeposit(amount, ref, desc, prefix) {
  const btn = prefix === 'dep'
    ? document.getElementById('depBtnText')
    : null;

  if (btn) btn.innerHTML = '<span class="loader"></span> Processing...';

  try {
    const data = await api('POST', `/wallets/${state.walletId}/deposit`, {
      amount: parseFloat(amount),
      referenceId: ref,
      description: desc || null,
    });

    toast('success', 'Deposit successful', `+${formatMoney(Math.abs(data.amount), state.currency)} added to wallet`);

    if (prefix === 'dep') {
      showResultCard('dep-result', data, 'deposit');
    }

    // Refresh balance
    await refreshBalance();

  } catch(e) {
    toast('error', 'Deposit failed', e.message);
  } finally {
    if (btn) btn.textContent = '↓ Deposit to Wallet';
  }
}

/* ═══════════════════════════════════════════════════════
   WITHDRAW
═══════════════════════════════════════════════════════ */
async function loadWithdrawInfo() {
  try {
    const w = await api('GET', `/wallets/${state.walletId}`);
    document.getElementById('with-available').textContent = formatMoney(w.balance, w.currency);
    state.balance = w.balance;
  } catch(e) {}
}

async function quickWithdraw() {
  const amount = document.getElementById('qwith-amount').value;
  const desc = document.getElementById('qwith-desc').value;
  if (!amount) { toast('error', 'Missing amount', 'Enter an amount to withdraw'); return; }
  await executeWithdraw(amount, genRefValue(), desc, 'qwith');
}

async function doWithdraw() {
  const amount = document.getElementById('with-amount').value;
  const ref = document.getElementById('with-ref').value.trim();
  const desc = document.getElementById('with-desc').value;

  if (!amount || !ref) { toast('error', 'Missing fields', 'Amount and Reference ID are required'); return; }
  await executeWithdraw(amount, ref, desc, 'with');
}

async function executeWithdraw(amount, ref, desc, prefix) {
  const btn = prefix === 'with' ? document.getElementById('withBtnText') : null;
  if (btn) btn.innerHTML = '<span class="loader"></span> Processing...';

  try {
    const data = await api('POST', `/wallets/${state.walletId}/withdraw`, {
      amount: parseFloat(amount),
      referenceId: ref,
      description: desc || null,
    });

    toast('success', 'Withdrawal successful', `${formatMoney(Math.abs(data.amount), state.currency)} withdrawn`);

    if (prefix === 'with') {
      showResultCard('with-result', data, 'withdrawal');
    }

    await refreshBalance();
  } catch(e) {
    toast('error', 'Withdrawal failed', e.message);
  } finally {
    if (btn) btn.textContent = '↑ Withdraw from Wallet';
  }
}

/* ═══════════════════════════════════════════════════════
   TRANSFER
═══════════════════════════════════════════════════════ */
async function loadTransferInfo() {
  try {
    const w = await api('GET', `/wallets/${state.walletId}`);
    document.getElementById('trf-available').textContent = formatMoney(w.balance, w.currency);
    state.balance = w.balance;
  } catch(e) {}
}

async function doTransfer() {
  const toWallet = document.getElementById('trf-toWallet').value;
  const amount = document.getElementById('trf-amount').value;
  const ref = document.getElementById('trf-ref').value.trim();
  const desc = document.getElementById('trf-desc').value;

  if (!toWallet || !amount || !ref) {
    toast('error', 'Missing fields', 'Destination wallet, amount, and reference ID are required');
    return;
  }

  const btn = document.getElementById('trfBtnText');
  btn.innerHTML = '<span class="loader"></span> Processing...';

  try {
    const data = await api('POST', `/wallets/${state.walletId}/transfer`, {
      toWalletId: parseInt(toWallet),
      amount: parseFloat(amount),
      referenceId: ref,
      description: desc || null,
    });

    toast('success', 'Transfer complete', `${formatMoney(data.amount, state.currency)} sent to wallet #${toWallet}`);
    showTransferResult('trf-result', data);
    await refreshBalance();
  } catch(e) {
    toast('error', 'Transfer failed', e.message);
  } finally {
    btn.textContent = '⇄ Execute Transfer';
  }
}

/* ═══════════════════════════════════════════════════════
   LOOKUP
═══════════════════════════════════════════════════════ */
async function doLookup() {
  const ref = document.getElementById('lookup-ref').value.trim();
  if (!ref) { toast('error', 'Missing reference', 'Enter a reference ID to look up'); return; }

  const result = document.getElementById('lookup-result');
  result.classList.remove('visible');
  result.innerHTML = '<div style="text-align:center; padding:20px"><div class="loader"></div></div>';
  result.classList.add('visible');

  try {
    const data = await api('GET', `/transactions/${encodeURIComponent(ref)}`);
    const isCredit = parseFloat(data.amount) > 0;
    result.innerHTML = `
      <div class="result-row"><span class="result-key">Transaction ID</span><span class="result-val">#${data.transactionId}</span></div>
      <div class="result-row"><span class="result-key">Type</span><span class="result-val">${badgeForType(data.type)}</span></div>
      <div class="result-row"><span class="result-key">Amount</span><span class="result-val ${isCredit ? 'text-green' : 'text-red'}">${isCredit ? '+' : ''}${formatMoney(Math.abs(data.amount), state.currency)}</span></div>
      <div class="result-row"><span class="result-key">Wallet ID</span><span class="result-val">#${data.walletId}</span></div>
      <div class="result-row"><span class="result-key">Reference ID</span><span class="result-val">${data.referenceId}</span></div>
      <div class="result-row"><span class="result-key">Description</span><span class="result-val">${data.description || '—'}</span></div>
      <div class="result-row"><span class="result-key">Created At</span><span class="result-val">${formatDate(data.createdAt)}</span></div>
    `;
  } catch(e) {
    result.innerHTML = `<div style="color:var(--red); font-size:12px; padding:12px">⚠ ${e.message}</div>`;
  }
}

/* ═══════════════════════════════════════════════════════
   RESULT CARDS
═══════════════════════════════════════════════════════ */
function showResultCard(id, tx, type) {
  const el = document.getElementById(id);
  const isCredit = parseFloat(tx.amount) > 0;
  el.innerHTML = `
    <div style="margin-bottom:10px; font-size:10px; color:var(--text-3); letter-spacing:2px; text-transform:uppercase;">
      ✓ Transaction recorded
    </div>
    <div class="result-row"><span class="result-key">ID</span><span class="result-val">#${tx.transactionId}</span></div>
    <div class="result-row"><span class="result-key">Amount</span><span class="result-val ${isCredit ? 'text-green' : 'text-red'}">${isCredit ? '+' : ''}${formatMoney(Math.abs(tx.amount), state.currency)}</span></div>
    <div class="result-row"><span class="result-key">Reference</span><span class="result-val">${tx.referenceId}</span></div>
    <div class="result-row"><span class="result-key">Created</span><span class="result-val">${formatDate(tx.createdAt)}</span></div>
  `;
  el.style.marginTop = '14px';
  el.classList.add('visible');
}

function showTransferResult(id, transfer) {
  const el = document.getElementById(id);
  el.innerHTML = `
    <div style="margin-bottom:10px; font-size:10px; color:var(--text-3); letter-spacing:2px; text-transform:uppercase;">
      ✓ Transfer complete
    </div>
    <div class="result-row"><span class="result-key">Amount</span><span class="result-val text-amber">${formatMoney(transfer.amount, state.currency)}</span></div>
    <div class="result-row"><span class="result-key">Reference</span><span class="result-val">${transfer.referenceId}</span></div>
    <div class="result-row"><span class="result-key">Debit Entry</span><span class="result-val">#${transfer.debit.transactionId}</span></div>
    <div class="result-row"><span class="result-key">Credit Entry</span><span class="result-val">#${transfer.credit.transactionId}</span></div>
  `;
  el.style.marginTop = '14px';
  el.classList.add('visible');
}

/* ═══════════════════════════════════════════════════════
   HELPERS
═══════════════════════════════════════════════════════ */
async function refreshBalance() {
  try {
    const w = await api('GET', `/wallets/${state.walletId}`);
    state.balance = w.balance;
    state.currency = w.currency;
    saveSession();
    // Update topbar (already shown via walletId)
  } catch(e) {}
}

function formatMoney(amount, currency) {
  const num = parseFloat(amount);
  if (isNaN(num)) return '—';
  try {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: currency || 'USD',
      minimumFractionDigits: 2,
      maximumFractionDigits: 4,
    }).format(num);
  } catch(e) {
    return `${currency} ${num.toFixed(2)}`;
  }
}

function formatDate(iso) {
  if (!iso) return '—';
  const d = new Date(iso);
  return d.toLocaleString('en-GB', {
    day: '2-digit', month: 'short', year: 'numeric',
    hour: '2-digit', minute: '2-digit',
  });
}

function genRefValue() {
  const ts = Date.now().toString(36).toUpperCase();
  const rand = Math.random().toString(36).slice(2, 6).toUpperCase();
  return `REF-${ts}-${rand}`;
}

function genRef(inputId) {
  document.getElementById(inputId).value = genRefValue();
}

/* ═══════════════════════════════════════════════════════
   TOAST
═══════════════════════════════════════════════════════ */
function toast(type, title, msg) {
  const icons = { success: '✓', error: '✕', info: '◈' };
  const container = document.getElementById('toastContainer');

  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = `
    <div class="toast-icon">${icons[type] || '◈'}</div>
    <div class="toast-body">
      <div class="toast-title">${title}</div>
      <div class="toast-msg">${msg}</div>
    </div>
    <div class="toast-close" onclick="this.parentElement.remove()">✕</div>
  `;
  container.appendChild(el);

  setTimeout(() => {
    el.style.opacity = '0';
    el.style.transform = 'translateX(20px)';
    el.style.transition = 'all 0.3s ease';
    setTimeout(() => el.remove(), 300);
  }, 4000);
}

/* ═══════════════════════════════════════════════════════
   MODAL
═══════════════════════════════════════════════════════ */
function closeModal() {
  document.getElementById('confirmModal').classList.remove('visible');
}

// Allow Enter key on login
document.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    if (document.getElementById('authScreen').classList.contains('visible')) {
      const loginVisible = document.getElementById('loginForm').style.display !== 'none';
      if (loginVisible) doLogin();
      else doRegister();
    }
  }
});
</script>
</body>
</html>
